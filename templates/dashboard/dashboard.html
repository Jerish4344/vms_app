{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Vehicle Management System{% endblock %}

{% block extra_css %}
<link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
<!-- Add Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Add Leaflet CSS for maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
  /* Enhanced dashboard styles */
  .stats-card {
    transition: all 0.3s ease;
    border-left: 4px solid #4e73df;
  }

  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .stats-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(78, 115, 223, 0.1);
    border-radius: 50%;
    color: #4e73df;
  }
  
  .stats-icon i {
    font-size: 1.8rem;
  }
  
  .stats-title {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1rem;
    font-weight: 700;
    color: #6c757d;
    margin-bottom: 0.5rem;
  }
  
  .stats-number {
    font-size: 1.8rem;
    font-weight: 700;
    color: #5a5c69;
    margin-bottom: 0;
  }
  
  .welcome-card {
    background-color: #f8f9fc;
    border-radius: 0.35rem;
    padding: 1.5rem;
    border-left: 4px solid #4e73df;
  }
  
  .chart-container {
    position: relative;
    height: 250px;
    width: 100%;
  }
  
  .active-trip-card {
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    background-color: #fff;
  }

  #dailyView, #weeklyView {
    height: 280px;
    position: relative;
  }

  #dailyActivityChart, #weeklyActivityChart {
    max-height: 100%;
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="row">
    <div class="col-lg-12">
      <div class="welcome-card mb-4">
        <h1>Welcome, {{ request.user.get_full_name }}</h1>
        <p>{{ request.user.get_user_type_display }} Dashboard</p>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row">
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Total Vehicles</h6>
              <h3 class="stats-number">{{ total_vehicles }}</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-car"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Active Trips</h6>
              <h3 class="stats-number">{{ active_trips }}</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-route"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    {% if request.user.user_type == 'admin' or request.user.user_type == 'manager' %}
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Upcoming Maintenance</h6>
              <h3 class="stats-number">{{ upcoming_maintenance|length }}</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-tools"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Expiring Documents</h6>
              <h3 class="stats-number">{{ expiring_documents|length }}</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-file-alt"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    
    {% if request.user.user_type == 'vehicle_manager' %}
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Available Vehicles</h6>
              <h3 class="stats-number">{{ available_vehicles }}</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Vehicles In Use</h6>
              <h3 class="stats-number">{{ unavailable_vehicles }}</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-car-side"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    
    {% if request.user.user_type == 'driver' %}
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Monthly Distance</h6>
              <h3 class="stats-number">{{ monthly_distance }} km</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-road"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card stats-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="stats-title">Monthly Trips</h6>
              <h3 class="stats-number">{{ monthly_trips }}</h3>
            </div>
            <div class="stats-icon">
              <i class="fas fa-map-marked-alt"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Admin and Manager Dashboard -->
  {% if request.user.user_type == 'admin' or request.user.user_type == 'manager' %}
  <div class="row">
    <!-- Vehicle Status Chart -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Vehicle Status</h5>
        </div>
        <div class="card-body">
          <canvas id="vehicleStatusChart" height="180"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Vehicle Types Chart -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Vehicles by Type</h5>
        </div>
        <div class="card-body">
          <canvas id="vehicleTypesChart" height="180"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Fuel Expenses Overview -->
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title">Fuel Expenses Overview</h5>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-primary active" id="monthlyFuelBtn">Monthly</button>
            <button type="button" class="btn btn-outline-primary" id="weeklyFuelBtn">Weekly</button>
            <button type="button" class="btn btn-outline-primary" id="dailyFuelBtn">Daily</button>
          </div>
        </div>
        <div class="card-body">
          <div id="monthlyFuelView">
            <canvas id="fuelExpensesMonthlyChart" height="450"></canvas>
          </div>
          <div id="weeklyFuelView" style="display:none;">
            <canvas id="fuelExpensesWeeklyChart" height="450"></canvas>
          </div>
          <div id="dailyFuelView" style="display:none;">
            <canvas id="fuelExpensesDailyChart" height="450"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Ongoing Trips Table -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Ongoing Trips</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Driver</th>
                  <th>Started</th>
                  <th>Location</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for trip in ongoing_trips %}
                <tr>
                  <td>{{ trip.vehicle.license_plate }}</td>
                  <td>{{ trip.driver.get_full_name }}</td>
                  <td>{{ trip.start_time|date:"M d, Y H:i" }}</td>
                  <td>
                    <button class="btn btn-sm btn-primary view-location" data-trip-id="{{ trip.id }}">
                      <i class="fas fa-map-marker-alt"></i> View
                    </button>
                  </td>
                  <td>
                    <a href="{% url 'trip_detail' trip.id %}" class="btn btn-sm btn-info">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center">No ongoing trips</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recent Accidents -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Recent Accidents</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Vehicle</th>
                  <th>Driver</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for accident in recent_accidents %}
                <tr>
                  <td>{{ accident.date_time|date:"M d, Y" }}</td>
                  <td>{{ accident.vehicle.license_plate }}</td>
                  <td>{{ accident.driver.get_full_name }}</td>
                  <td>
                    <span class="badge bg-{{ accident.status|status_color }}">
                      {{ accident.get_status_display }}
                    </span>
                  </td>
                  <td>
                    <a href="{% url 'accident_detail' accident.id %}" class="btn btn-sm btn-info">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center">No recent accidents</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Driver Performance -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Top Drivers This Month</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Driver</th>
                  <th>Total Distance</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody>
                {% for driver in driver_performance %}
                <tr>
                  <td>{{ driver.driver__first_name }} {{ driver.driver__last_name }}</td>
                  <td>{{ driver.total_distance }} km</td>
                  <td>{{ driver.formatted_duration }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="2" class="text-center">No data available</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Expiring Documents -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Expiring Documents</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Document</th>
                  <th>Vehicle</th>
                  <th>Expiry Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for document in expiring_documents %}
                <tr>
                  <td>{{ document.document_type.name }}</td>
                  <td>{{ document.vehicle.license_plate }}</td>
                  <td>
                    <span class="{% if document.is_expired %}text-danger{% endif %}">
                      {{ document.expiry_date|date:"M d, Y" }}
                    </span>
                  </td>
                  <td>
                    <a href="{% url 'document_detail' document.id %}" class="btn btn-sm btn-info">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No expiring documents</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Vehicle Manager Dashboard -->
  {% if request.user.user_type == 'vehicle_manager' %}
  <div class="row">
    <!-- Maintenance Status Chart -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Maintenance Status</h5>
        </div>
        <div class="card-body">
          <canvas id="maintenanceStatusChart" height="180"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Vehicle Availability Chart -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Vehicle Availability</h5>
        </div>
        <div class="card-body">
          <canvas id="vehicleAvailabilityChart" height="180"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Fuel Efficiency by Vehicle (NEW) -->
    <div class="col-lg-12">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Fuel Efficiency by Vehicle</h5>
        </div>
        <div class="card-body">
          <canvas id="fuelEfficiencyChart" height="180"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Pending Maintenance -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Pending Maintenance</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Type</th>
                  <th>Scheduled Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for maintenance in pending_maintenance %}
                <tr>
                  <td>{{ maintenance.vehicle.license_plate }}</td>
                  <td>{{ maintenance.maintenance_type.name }}</td>
                  <td>{{ maintenance.scheduled_date|date:"M d, Y" }}</td>
                  <td>
                    <a href="{% url 'maintenance_detail' maintenance.id %}" class="btn btn-sm btn-info">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No pending maintenance</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Fuel Efficiency -->
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Fuel Efficiency Details</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Efficiency (km/L)</th>
                </tr>
              </thead>
              <tbody>
                {% for item in fuel_efficiency %}
                <tr>
                  <td>{{ item.vehicle.license_plate }} ({{ item.vehicle.make }} {{ item.vehicle.model }})</td>
                  <td>{{ item.efficiency }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="2" class="text-center">No data available</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Driver Dashboard -->
  {% if request.user.user_type == 'driver' %}
  <div class="row">
    <!-- Ongoing Trips -->
    <div class="col-lg-12">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Your Current Trip</h5>
        </div>
        <div class="card-body">
          {% if ongoing_trips %}
            {% for trip in ongoing_trips %}
            <div class="active-trip-card">
              <div class="row">
                <div class="col-md-6">
                  <h4>{{ trip.vehicle.make }} {{ trip.vehicle.model }} ({{ trip.vehicle.license_plate }})</h4>
                  <p><strong>Started:</strong> {{ trip.start_time|date:"M d, Y H:i" }}</p>
                  <p><strong>Purpose:</strong> {{ trip.purpose }}</p>
                  <p><strong>Start Odometer:</strong> {{ trip.start_odometer }} km</p>
                </div>
                <div class="col-md-6 text-md-end">
                  <a href="{% url 'end_trip' trip.id %}" class="btn btn-warning mb-2">
                    <i class="fas fa-flag-checkered"></i> End Trip
                  </a>
                  <a href="{% url 'trip_detail' trip.id %}" class="btn btn-info mb-2">
                    <i class="fas fa-info-circle"></i> Details
                  </a>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-5">
              <h4>No active trips</h4>
              <a href="{% url 'start_trip' %}" class="btn btn-primary mt-3">
                <i class="fas fa-play"></i> Start New Trip
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Driver Activity Charts -->
  <div class="row">
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Your Monthly Trip Distance</h5>
        </div>
        <div class="card-body">
          <canvas id="distanceChart" height="250"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Your Driving Hours</h5>
        </div>
        <div class="card-body">
          <canvas id="hoursChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Daily/Weekly Activity -->
  <div class="row">
    <div class="col-lg-12">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Daily Activity Breakdown</h5>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-primary active" id="dailyViewBtn">Daily</button>
            <button type="button" class="btn btn-outline-primary" id="weeklyViewBtn">Weekly</button>
          </div>
        </div>
        <div class="card-body">
          <div id="dailyView">
            <canvas id="dailyActivityChart" height="250"></canvas>
          </div>
          <div id="weeklyView" style="display:none;">
            <canvas id="weeklyActivityChart" height="250"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Recent Trips -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Your Recent Trips</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>DATE</th>
                  <th>VEHICLE</th>
                  <th>DISTANCE</th>
                  <th>DURATION</th>
                  <th>STATUS</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody>
                {% for trip in recent_trips %}
                <tr>
                  <td>{{ trip.start_time|date:"M d, Y" }}</td>
                  <td>{{ trip.vehicle.license_plate }}</td>
                  <td>
                    {% if trip.distance is not None %}
                      {{ trip.distance }} km
                    {% else %}
                      In progress
                    {% endif %}
                  </td>
                  <td>
                    {% if trip.formatted_duration %}
                      {{ trip.formatted_duration }}
                    {% else %}
                      In progress
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{{ trip.status|status_color }}">
                      {{ trip.get_status_display }}
                    </span>
                  </td>
                  <td>
                    <a href="{% url 'trip_detail' trip.id %}" class="btn btn-sm btn-info">
                      <i class="fas fa-info-circle"></i>
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center">No recent trips</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recent Fuel Transactions -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title">Your Recent Fuel Transactions</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>DATE</th>
                  <th>VEHICLE</th>
                  <th>AMOUNT</th>
                </tr>
              </thead>
              <tbody>
                {% for fuel in recent_fuel %}
                <tr>
                  <td>{{ fuel.date|date:"M d, Y" }}</td>
                  <td>{{ fuel.vehicle.license_plate }}</td>
                  <td>{{ fuel.quantity }} L</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center">No recent fuel transactions</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Location Map Modal -->
<div class="modal fade" id="locationMapModal" tabindex="-1" aria-labelledby="locationMapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="locationMapModalLabel">Vehicle Location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="locationMap" style="height: 400px;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Google Maps configuration - REPLACE WITH YOUR ACTUAL API KEY
const GOOGLE_MAPS_CONFIG = {
  apiKey: 'AIzaSyDMAkESwj75ZhnMIlLK25zHiM1oAUPZtbo', // Your actual API key
  libraries: ['geometry', 'places']
};

// Google Maps API loading utility with better error handling
function ensureGoogleMapsLoaded() {
  return new Promise((resolve, reject) => {
    // Check if Google Maps is already loaded
    if (window.google && window.google.maps) {
      resolve();
      return;
    }
    
    // Validate API key
    if (!GOOGLE_MAPS_CONFIG.apiKey || GOOGLE_MAPS_CONFIG.apiKey.length < 10) {
      reject(new Error('Google Maps API key is not configured properly. Please check your API key.'));
      return;
    }
    
    // Check if script is already being loaded
    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
      // Script exists, wait for it to load
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds timeout
      
      const checkGoogle = setInterval(() => {
        attempts++;
        if (window.google && window.google.maps) {
          clearInterval(checkGoogle);
          resolve();
        } else if (attempts >= maxAttempts) {
          clearInterval(checkGoogle);
          reject(new Error('Timeout waiting for Google Maps to load'));
        }
      }, 100);
      return;
    }
    
    // Create and load the script
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_CONFIG.apiKey}&libraries=${GOOGLE_MAPS_CONFIG.libraries.join(',')}&callback=initGoogleMaps`;
    script.async = true;
    script.defer = true;
    
    // Global callback function
    window.initGoogleMaps = function() {
      delete window.initGoogleMaps; // Clean up
      resolve();
    };
    
    script.onerror = (error) => {
      delete window.initGoogleMaps; // Clean up
      reject(new Error('Failed to load Google Maps API. Check your API key and network connection.'));
    };
    
    document.head.appendChild(script);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  // Chart colors
  const chartColors = {
    blue: 'rgba(54, 162, 235, 0.7)',
    blueLight: 'rgba(54, 162, 235, 0.2)',
    blueBorder: 'rgba(54, 162, 235, 1)',
    green: 'rgba(75, 192, 192, 0.7)',
    greenLight: 'rgba(75, 192, 192, 0.2)',
    greenBorder: 'rgba(75, 192, 192, 1)',
    red: 'rgba(255, 99, 132, 0.7)',
    redBorder: 'rgba(255, 99, 132, 1)',
    yellow: 'rgba(255, 206, 86, 0.7)',
    yellowBorder: 'rgba(255, 206, 86, 1)',
    orange: 'rgba(255, 159, 64, 0.7)',
    orangeBorder: 'rgba(255, 159, 64, 1)',
    purple: 'rgba(153, 102, 255, 0.7)',
    purpleBorder: 'rgba(153, 102, 255, 1)',
    gray: 'rgba(201, 203, 207, 0.7)',
    grayBorder: 'rgba(201, 203, 207, 1)'
  };
  
  // Chart Options
  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: true,
        position: 'top',
        labels: {
          font: {
            size: 11
          }
        }
      },
      tooltip: {
        mode: 'index',
        intersect: false,
      }
    },
    scales: {
      y: {
        beginAtZero: true
      }
    }
  };
  
  // Admin & Manager Dashboard Charts
  {% if request.user.user_type == 'admin' or request.user.user_type == 'manager' %}
  // Vehicle Status Chart
  try {
    const vehicleStatusCtx = document.getElementById('vehicleStatusChart').getContext('2d');
    const vehicleStatusData = {
      labels: [{% for item in vehicle_status %}'{{ item.status|capfirst }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for item in vehicle_status %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
          chartColors.green,
          chartColors.blue,
          chartColors.orange,
          chartColors.gray
        ],
        borderWidth: 1
      }]
    };
    
    const vehicleStatusChart = new Chart(vehicleStatusCtx, {
      type: 'doughnut',
      data: vehicleStatusData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating vehicle status chart:', e);
  }
  
  // Vehicle Types Chart
  try {
    const vehicleTypesCtx = document.getElementById('vehicleTypesChart').getContext('2d');
    const vehicleTypesData = {
      labels: [{% for item in vehicle_types %}'{{ item.vehicle_type__name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for item in vehicle_types %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
          chartColors.red,
          chartColors.blue,
          chartColors.yellow,
          chartColors.green,
          chartColors.purple
        ],
        borderWidth: 1
      }]
    };
    
    const vehicleTypesChart = new Chart(vehicleTypesCtx, {
      type: 'pie',
      data: vehicleTypesData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating vehicle types chart:', e);
  }
  
  // Fuel Expenses Charts
  try {
    // Monthly Fuel Expenses Chart
    const fuelExpensesMonthlyCtx = document.getElementById('fuelExpensesMonthlyChart').getContext('2d');
    const fuelExpensesMonthlyData = {
      labels: [{% for item in monthly_fuel %}'{{ item.month_name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Monthly Fuel Expenses',
        data: [{% for item in monthly_fuel %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: chartColors.blue,
        borderColor: chartColors.blueBorder,
        borderWidth: 2
      }]
    };
    
    const fuelExpensesMonthlyChart = new Chart(fuelExpensesMonthlyCtx, {
      type: 'bar',
      data: fuelExpensesMonthlyData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Amount',
              font: {
                size: 12
              }
            },
            ticks: {
              font: {
                size: 11
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month',
              font: {
                size: 12
              }
            },
            ticks: {
              font: {
                size: 11
              }
            }
          }
        }
      }
    });
    
    // Weekly Fuel Expenses Chart
    const fuelExpensesWeeklyCtx = document.getElementById('fuelExpensesWeeklyChart').getContext('2d');
    const fuelExpensesWeeklyData = {
      labels: [{% for item in weekly_fuel %}'{{ item.week }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Weekly Fuel Expenses',
        data: [{% for item in weekly_fuel %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: chartColors.green,
        borderColor: chartColors.greenBorder,
        borderWidth: 2
      }]
    };
    
    const fuelExpensesWeeklyChart = new Chart(fuelExpensesWeeklyCtx, {
      type: 'bar',
      data: fuelExpensesWeeklyData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Amount',
              font: {
                size: 12
              }
            },
            ticks: {
              font: {
                size: 11
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Week',
              font: {
                size: 12
              }
            },
            ticks: {
              font: {
                size: 11
              },
              maxRotation: 45,
              minRotation: 30
            }
          }
        }
      }
    });
    
    // Daily Fuel Expenses Chart
    const fuelExpensesDailyCtx = document.getElementById('fuelExpensesDailyChart').getContext('2d');
    const fuelExpensesDailyData = {
      labels: [{% for item in daily_fuel %}'{{ item.date }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Daily Fuel Expenses',
        data: [{% for item in daily_fuel %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: chartColors.orange,
        borderColor: chartColors.orangeBorder,
        borderWidth: 2
      }]
    };
    
    const fuelExpensesDailyChart = new Chart(fuelExpensesDailyCtx, {
      type: 'bar',
      data: fuelExpensesDailyData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Amount',
              font: {
                size: 12
              }
            },
            ticks: {
              font: {
                size: 11
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Date',
              font: {
                size: 12
              }
            },
            ticks: {
              font: {
                size: 11
              },
              maxRotation: 45,
              minRotation: 30
            }
          }
        }
      }
    });
    
    // Toggle buttons for fuel expense views
    const monthlyFuelBtn = document.getElementById('monthlyFuelBtn');
    const weeklyFuelBtn = document.getElementById('weeklyFuelBtn');
    const dailyFuelBtn = document.getElementById('dailyFuelBtn');
    const monthlyFuelView = document.getElementById('monthlyFuelView');
    const weeklyFuelView = document.getElementById('weeklyFuelView');
    const dailyFuelView = document.getElementById('dailyFuelView');
    
    if (monthlyFuelBtn && weeklyFuelBtn && dailyFuelBtn) {
      monthlyFuelBtn.addEventListener('click', function() {
        monthlyFuelView.style.display = 'block';
        weeklyFuelView.style.display = 'none';
        dailyFuelView.style.display = 'none';
        monthlyFuelBtn.classList.add('active');
        weeklyFuelBtn.classList.remove('active');
        dailyFuelBtn.classList.remove('active');
      });
      
      weeklyFuelBtn.addEventListener('click', function() {
        monthlyFuelView.style.display = 'none';
        weeklyFuelView.style.display = 'block';
        dailyFuelView.style.display = 'none';
        monthlyFuelBtn.classList.remove('active');
        weeklyFuelBtn.classList.add('active');
        dailyFuelBtn.classList.remove('active');
      });
      
      dailyFuelBtn.addEventListener('click', function() {
        monthlyFuelView.style.display = 'none';
        weeklyFuelView.style.display = 'none';
        dailyFuelView.style.display = 'block';
        monthlyFuelBtn.classList.remove('active');
        weeklyFuelBtn.classList.remove('active');
        dailyFuelBtn.classList.add('active');
      });
    }
  } catch (e) {
    console.error('Error creating fuel expenses charts:', e);
  }
  {% endif %}
  
  // Vehicle Manager Dashboard Charts
  {% if request.user.user_type == 'vehicle_manager' %}
  // Maintenance Status Chart
  try {
    const maintenanceStatusCtx = document.getElementById('maintenanceStatusChart').getContext('2d');
    const maintenanceStatusData = {
      labels: [{% for item in maintenance_summary %}'{{ item.status|capfirst }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for item in maintenance_summary %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
          chartColors.orange,
          chartColors.green,
          chartColors.blue,
          chartColors.gray
        ],
        borderWidth: 1
      }]
    };
    
    const maintenanceStatusChart = new Chart(maintenanceStatusCtx, {
      type: 'doughnut',
      data: maintenanceStatusData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating maintenance status chart:', e);
  }
  
  // Vehicle Availability Chart
  try {
    const vehicleAvailabilityCtx = document.getElementById('vehicleAvailabilityChart').getContext('2d');
    const vehicleAvailabilityData = {
      labels: ['Available', 'Not Available'],
      datasets: [{
        data: [{{ available_vehicles }}, {{ unavailable_vehicles }}],
        backgroundColor: [
          chartColors.green,
          chartColors.red,
        ],
        borderWidth: 1
      }]
    };
    
    const vehicleAvailabilityChart = new Chart(vehicleAvailabilityCtx, {
      type: 'pie',
      data: vehicleAvailabilityData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating vehicle availability chart:', e);
  }
  
  // Fuel Efficiency Chart
  try {
    const fuelEfficiencyCtx = document.getElementById('fuelEfficiencyChart').getContext('2d');
    
    {% if fuel_efficiency_detailed %}
    const vehicleLabels = [{% for item in fuel_efficiency_detailed %}'{{ item.vehicle.license_plate }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const efficiencyValues = [{% for item in fuel_efficiency_detailed %}{{ item.efficiency }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    {% else %}
    const vehicleLabels = ['No Data'];
    const efficiencyValues = [0];
    {% endif %}
    
    const fuelEfficiencyChart = new Chart(fuelEfficiencyCtx, {
      type: 'bar',
      data: {
        labels: vehicleLabels,
        datasets: [{
          label: 'Efficiency (km/L)',
          data: efficiencyValues,
          backgroundColor: chartColors.green,
          borderColor: chartColors.greenBorder,
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Efficiency (km/L)',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 9
              }
            }
          },
          y: {
            ticks: {
              font: {
                size: 9
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating fuel efficiency chart:', e);
  }
  {% endif %}
  
  // Driver Dashboard Charts
  {% if request.user.user_type == 'driver' %}
  // Monthly Distance Chart
  try {
    const distanceChartCtx = document.getElementById('distanceChart').getContext('2d');
    
    {% if driver_months %}
    const months = [{% for item in driver_months %}'{{ item.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const distances = [{% for item in driver_months %}{{ item.distance }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    {% else %}
    // Default data if no data available
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const distances = [0, 0, 0, 0, 0, 0];
    {% endif %}
    
    const distanceChart = new Chart(distanceChartCtx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [{
          label: 'Distance (km)',
          data: distances,
          backgroundColor: chartColors.green,
          borderColor: chartColors.greenBorder,
          borderWidth: 1
        }]
      },
      options: {
        ...chartOptions,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Distance (km)',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 9
              }
            }
          },
          x: {
            ticks: {
              font: {
                size: 9
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating distance chart:', e);
  }
  
  // Monthly Hours Chart
  try {
    const hoursChartCtx = document.getElementById('hoursChart').getContext('2d');
    
    {% if driver_hours %}
    const hoursMonths = [{% for item in driver_hours %}'{{ item.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const hours = [{% for item in driver_hours %}{{ item.hours }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    {% else %}
    // Default data if no data available
    const hoursMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const hours = [0, 0, 0, 0, 0, 0];
    {% endif %}
    
    const hoursChart = new Chart(hoursChartCtx, {
      type: 'line',
      data: {
        labels: hoursMonths,
        datasets: [{
          label: 'Driving Hours',
          data: hours,
          backgroundColor: chartColors.blueLight,
          borderColor: chartColors.blueBorder,
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }]
      },
      options: {
        ...chartOptions,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Hours',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 9
              }
            }
          },
          x: {
            ticks: {
              font: {
                size: 9
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating hours chart:', e);
  }
  
  // Daily Activity Chart
  try {
    const dailyActivityCtx = document.getElementById('dailyActivityChart').getContext('2d');
    
    {% if driver_daily_activity %}
    const dailyDates = [{% for item in driver_daily_activity %}'{{ item.date }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const dailyHours = [{% for item in driver_daily_activity %}{{ item.hours }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    {% else %}
    // Default data if no data available
    const dailyDates = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
    const dailyHours = [0, 0, 0, 0, 0, 0, 0];
    {% endif %}
    
    const dailyActivityChart = new Chart(dailyActivityCtx, {
      type: 'bar',
      data: {
        labels: dailyDates,
        datasets: [{
          label: 'Hours',
          data: dailyHours,
          backgroundColor: chartColors.orange,
          borderColor: chartColors.orangeBorder,
          borderWidth: 1
        }]
      },
      options: {
        ...chartOptions,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Hours',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 9
              }
            }
          },
          x: {
            ticks: {
              font: {
                size: 9
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating daily activity chart:', e);
  }
  
  // Weekly Activity Chart
  try {
    const weeklyActivityCtx = document.getElementById('weeklyActivityChart').getContext('2d');
    
    {% if driver_weekly_activity %}
    const weeklyLabels = [{% for item in driver_weekly_activity %}'{{ item.week }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const weeklyHours = [{% for item in driver_weekly_activity %}{{ item.hours }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    {% else %}
    // Default data if no data available
    const weeklyLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'];
    const weeklyHours = [0, 0, 0, 0, 0, 0];
    {% endif %}
    
    const weeklyActivityChart = new Chart(weeklyActivityCtx, {
      type: 'bar',
      data: {
        labels: weeklyLabels,
        datasets: [{
          label: 'Hours',
          data: weeklyHours,
          backgroundColor: chartColors.blue,
          borderColor: chartColors.blueBorder,
          borderWidth: 1
        }]
      },
      options: {
        ...chartOptions,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Hours',
              font: {
                size: 10
              }
            },
            ticks: {
              font: {
                size: 9
              }
            }
          },
          x: {
            ticks: {
              font: {
                size: 9
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error creating weekly activity chart:', e);
  }
  
  // Toggle between daily and weekly views
  const dailyViewBtn = document.getElementById('dailyViewBtn');
  const weeklyViewBtn = document.getElementById('weeklyViewBtn');
  const dailyView = document.getElementById('dailyView');
  const weeklyView = document.getElementById('weeklyView');
  
  if (dailyViewBtn && weeklyViewBtn) {
    dailyViewBtn.addEventListener('click', function() {
      dailyView.style.display = 'block';
      weeklyView.style.display = 'none';
      dailyViewBtn.classList.add('active');
      weeklyViewBtn.classList.remove('active');
    });
    
    weeklyViewBtn.addEventListener('click', function() {
      dailyView.style.display = 'none';
      weeklyView.style.display = 'block';
      dailyViewBtn.classList.remove('active');
      weeklyViewBtn.classList.add('active');
    });
  }
  {% endif %}
  
  // Location Map Functionality - UPDATED TO USE GOOGLE MAPS
  let map = null;
  let currentMarkers = [];
  let currentPolylines = [];
  const viewLocationButtons = document.querySelectorAll('.view-location');
  const locationMapModal = document.getElementById('locationMapModal');
  
  // Clear all markers and polylines from the map
  function clearMapElements() {
    if (!map) return;
    
    // Remove all markers
    currentMarkers.forEach(marker => {
      marker.setMap(null);
    });
    currentMarkers = [];
    
    // Remove all polylines
    currentPolylines.forEach(polyline => {
      polyline.setMap(null);
    });
    currentPolylines = [];
  }
  
  if (viewLocationButtons.length > 0 && locationMapModal) {
    viewLocationButtons.forEach(button => {
      button.addEventListener('click', async function() {
        const tripId = this.dataset.tripId;
        
        try {
          // Ensure Google Maps is loaded
          await ensureGoogleMapsLoaded();
          
          // Initialize map if not already initialized
          if (!map) {
            map = new google.maps.Map(document.getElementById('locationMap'), {
              zoom: 13,
              center: { lat: 0, lng: 0 },
              mapTypeId: google.maps.MapTypeId.ROADMAP,
              zoomControl: true,
              mapTypeControl: true,
              scaleControl: true,
              streetViewControl: true,
              rotateControl: true,
              fullscreenControl: true
            });
          }
          
          // Show loading indicator
          const mapElement = document.getElementById('locationMap');
          mapElement.style.opacity = '0.5';
          
          // Fetch trip location data
          const response = await fetch(`/api/location-logs/?trip=${tripId}`);
          
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          const data = await response.json();
          
          // Clear existing markers and polylines
          clearMapElements();
          
          if (data.length > 0) {
            const latestLocation = data[data.length - 1];
            const position = { 
              lat: latestLocation.latitude, 
              lng: latestLocation.longitude 
            };
            
            // Center map on the latest location
            map.setCenter(position);
            map.setZoom(13);
            
            // Add marker for the latest location
            const latestMarker = new google.maps.Marker({
              position: position,
              map: map,
              title: 'Latest Location',
              icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
              }
            });
            
            // Create info window for latest location
            const latestInfoWindow = new google.maps.InfoWindow({
              content: `
                <div>
                  <strong>Latest Location</strong><br>
                  Time: ${new Date(latestLocation.timestamp).toLocaleString()}<br>
                  ${latestLocation.speed ? `Speed: ${(latestLocation.speed * 3.6).toFixed(1)} km/h` : ''}
                </div>
              `
            });
            
            // Open info window immediately and add click listener
            latestInfoWindow.open(map, latestMarker);
            latestMarker.addListener('click', () => {
              latestInfoWindow.open(map, latestMarker);
            });
            
            currentMarkers.push(latestMarker);
            
            // Add start location marker if there are multiple points
            if (data.length > 1) {
              const startLocation = data[0];
              const startPosition = {
                lat: startLocation.latitude,
                lng: startLocation.longitude
              };
              
              const startMarker = new google.maps.Marker({
                position: startPosition,
                map: map,
                title: 'Trip Start',
                icon: {
                  url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                }
              });
              
              const startInfoWindow = new google.maps.InfoWindow({
                content: `
                  <div>
                    <strong>Trip Start</strong><br>
                    Time: ${new Date(startLocation.timestamp).toLocaleString()}<br>
                    ${startLocation.speed ? `Speed: ${(startLocation.speed * 3.6).toFixed(1)} km/h` : ''}
                  </div>
                `
              });
              
              startMarker.addListener('click', () => {
                startInfoWindow.open(map, startMarker);
              });
              
              currentMarkers.push(startMarker);
            }
            
            // Create polyline for the trip path
            const tripPath = data.map(log => ({
              lat: log.latitude,
              lng: log.longitude
            }));
            
            const polyline = new google.maps.Polyline({
              path: tripPath,
              geodesic: true,
              strokeColor: '#2563EB',
              strokeOpacity: 1.0,
              strokeWeight: 3
            });
            
            polyline.setMap(map);
            currentPolylines.push(polyline);
            
            // Fit map to show all points
            if (tripPath.length > 1) {
              const bounds = new google.maps.LatLngBounds();
              tripPath.forEach(point => bounds.extend(point));
              map.fitBounds(bounds, { padding: 50 });
            }
            
          } else {
            // No location data available
            map.setCenter({ lat: 0, lng: 0 });
            map.setZoom(2);
            
            const noDataInfoWindow = new google.maps.InfoWindow({
              content: '<div style="color: #dc3545;"><strong>No location data available for this trip.</strong></div>',
              position: { lat: 0, lng: 0 }
            });
            
            noDataInfoWindow.open(map);
          }
          
          // Remove loading indicator
          mapElement.style.opacity = '1';
          
        } catch (error) {
          console.error('Error with Google Maps:', error);
          
          // Remove loading indicator
          const mapElement = document.getElementById('locationMap');
          if (mapElement) {
            mapElement.style.opacity = '1';
            
            // Show error message in the map container
            mapElement.innerHTML = `
              <div style="display: flex; align-items: center; justify-content: center; height: 100%; background-color: #f8f9fa; color: #dc3545; text-align: center; padding: 20px;">
                <div>
                  <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i><br>
                  <strong>Map Loading Error</strong><br>
                  <small>${error.message}</small><br><br>
                  <small style="color: #6c757d;">
                    Please check:
                    <ul style="list-style: none; padding: 0; margin: 10px 0;">
                      <li> Google Maps API key is valid</li>
                      <li> Maps JavaScript API is enabled</li>
                      <li> Internet connection is working</li>
                    </ul>
                  </small>
                </div>
              </div>
            `;
          }
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(locationMapModal);
        modal.show();
      });
    });
    
    // Handle modal events
    if (locationMapModal) {
      locationMapModal.addEventListener('shown.bs.modal', function() {
        // Trigger resize event for Google Maps when modal is shown
        if (map) {
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            // Re-center the map if needed
            if (currentMarkers.length > 0) {
              const bounds = new google.maps.LatLngBounds();
              currentMarkers.forEach(marker => {
                bounds.extend(marker.getPosition());
              });
              if (!bounds.isEmpty()) {
                map.fitBounds(bounds, { padding: 50 });
              }
            }
          }, 100);
        }
      });
      
      // Optional: Clear markers when modal is hidden to free memory
      locationMapModal.addEventListener('hidden.bs.modal', function() {
        // Uncomment if you want to clear the map when modal closes
        // clearMapElements();
      });
    }
  }
});
</script>
{% endblock %}